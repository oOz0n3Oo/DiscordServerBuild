<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport"content="width=device-width">
<title>Discord Server Builder Bot Admin</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Segoe UI',Tahoma,sans-serif;background:#0d1117;color:#e0e6ed}
.cont{max-width:1200px;margin:0 auto}
h1{color:#00d9ff;margin-bottom:20px}
h2{color:#00b4d9;margin-top:20px;margin-bottom:10px;font-size:1.3em}
h3{color:#00b4d9;margin-top:15px;margin-bottom:10px;font-size:1.1em}
nav{display:flex;gap:10px;border-bottom:1px solid#404854;padding-bottom:10px;margin-bottom:20px;flex-wrap:wrap}
nav button{background:#1a1f26;border:1px solid#404854;color:#00d9ff;padding:10px 15px;border-radius:6px;cursor:pointer;font-weight:bold;transition:0.2s}
nav button:hover{background:#2a3038;border-color:#00d9ff}
.tab{display:none;margin-bottom:30px}
.tab.active{display:block}
.card{background:#151b22;border:1px solid#404854;border-radius:8px;padding:20px;margin:10px 0;color:#e0e6ed}
.btn{background:#00d9ff;color:#000;border:0;padding:10px 16px;border-radius:6px;cursor:pointer;font-weight:bold;transition:0.2s}
.btn:hover{background:#00f5ff}
.btn.danger{background:#f85149;color:#fff}
.btn.danger:hover{background:#ff6b62}
input,select,textarea{background:#0d1117;color:#e0e6ed;border:1px solid#404854;padding:10px;border-radius:6px;font-family:monospace;font-size:0.95em}
input:focus,select:focus,textarea:focus{outline:0;border-color:#00d9ff;box-shadow:0 0 0 3px rgba(0,217,255,0.15)}
label{display:block;margin:15px 0 5px;font-weight:bold;color:#e0e6ed}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:20px}
@media(max-width:768px){.grid{grid-template-columns:1fr}}
table{width:100%;border-collapse:collapse;margin:10px 0;background:#0d1117;border:1px solid#404854;border-radius:6px;overflow:hidden}
table th{background:#1a1f26;color:#00d9ff;padding:12px;text-align:left;border-bottom:1px solid#404854;font-weight:bold}
table td{padding:12px;border-bottom:1px solid#404854;color:#e0e6ed}
table tr:hover{background:#1a1f26}
.alert{padding:12px;border-radius:6px;margin:10px 0;border-left:4px solid}
.success{background:#001f0f;border-left-color:#3fb950;color:#3fb950}
.error{background:#2a0f0a;border-left-color:#f85149;color:#f85149}
.info{background:#0d2038;border-left-color:#00d9ff;color:#00d9ff}
.color-box{display:inline-block;width:30px;height:30px;border-radius:4px;border:1px solid#404854;vertical-align:middle;margin-right:8px}
</style>
</head>
<body>
<div class="cont">
<div style="display:flex;justify-content:space-between;align-items:center;margin-b:20px">
<h1>ðŸ”’ Discord Server Builder Bot Admin Panel</h1>
<a href="/logout"class="btn danger"onclick="return confirm('Logout?')">Logout</a>
</div>
<nav>
<button onclick="show('cfg')">Config</button>
<button onclick="show('msgs')">Messages</button>
<button onclick="show('ch')">Channels</button>
<button onclick="show('r')">Roles</button>
<button onclick="show('p')">Permissions</button>
<button onclick="show('wh')">Webhooks</button>
<button onclick="show('data')">Import/Export</button>
</nav>

<div id="cfg"class="tab active">
<div class="card">
<label>API URL:</label>
<input type="text"id="api_url"placeholder="http://discord-server-builder:3000/api/v1">
<label>API Token:</label>
<input type="text"id="api_token"placeholder="YOUR_TOKEN">
<button class="btn"onclick="saveCfg()">Save API Config</button>
</div>
<div id="msg"></div>
</div>

<div id="msgs"class="tab">
<h2>Channel Welcome Messages</h2>
<div class="card">
<label>Select Channel:</label>
<select id="msg_ch_sel"></select>
<label>Message:</label>
<textarea id="msg_txt"rows="8"placeholder="Enter welcome message for this channel..."style="width:100%;font-family:monospace"></textarea>
<button class="btn"onclick="saveMsg()">Save Message</button>
</div>
<div id="msg_preview"class="card"style="background:#0d1117;border:2px dashed#404854;margin-t:15px">
<strong>Preview:</strong>
<div id="msg_prev"style="margin-t:10px;color:#c9d1d9"></div>
</div>
</div>

<div id="ch"class="tab">
<h2>Channel Management</h2>
<div class="card">
<label>Category:</label>
<select id="cat_sel"></select>
<label>Channel Name:</label>
<input type="text"id="ch_name"placeholder="channel-name">
<button class="btn"onclick="addCh()">Add Channel</button>
</div>
<h3>Existing Channels</h3>
<div id="ch_list"></div>
</div>

<div id="r"class="tab">
<h2>Role Management</h2>
<div class="card">
<label>Role Name:</label>
<input type="text"id="r_name"placeholder="Role Name">
<label>Color (hex):</label>
<input type="text"id="r_col"placeholder="#FF0000">
<button class="btn"onclick="addR()">Add Role</button>
</div>
<h3>Existing Roles</h3>
<table id="r_list"></table>
</div>

<div id="p"class="tab">
<h2>Permissions</h2>
<div class="card">
<label>Category:</label>
<select id="p_cat"></select>
<label>Role:</label>
<select id="p_role"></select>
<label><input type="checkbox"id="p_view">View Channel</label>
<label><input type="checkbox"id="p_send">Send Messages</label>
<button class="btn"onclick="addP()">Set Permission</button>
</div>
<h3>Permission Matrix</h3>
<div id="p_mat"></div>
</div>

<div id="wh"class="tab">
<h2>Webhooks</h2>
<div class="card">
<label>Trigger Event:</label>
<input type="text"id="wh_trig"placeholder="e.g., solve, first_blood">
<label>Webhook URL:</label>
<input type="text"id="wh_url"placeholder="https://example.com/webhook">
<button class="btn"onclick="addWh()">Add Webhook</button>
</div>
<h3>Active Webhooks</h3>
<table id="wh_list"><tr><th>ID</th><th>Trigger</th><th>URL</th><th>Action</th></tr></table>
</div>

<div id="data"class="tab">
<h2>Import / Export</h2>
<div class="card">
<button class="btn"onclick="exp()">ðŸ“¥ Export Config</button>
<button class="btn"onclick="doc.getElementById('file').click()">ðŸ“¤ Import Config</button>
<input type="file"id="file"style="display:none"accept=".json"onchange="imp(event)">
</div>
</div>
</div>

<script>
function show(t){document.querySelectorAll('.tab').forEach(e=>e.classList.remove('active'));document.getElementById(t).classList.add('active')}
function msg(m,t='success'){const d=document.getElementById('msg');d.innerHTML=`<div class="${t}">${m}</div>`}
function saveCfg(){
 fetch('/api/cfg',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({api:{url:document.getElementById('api_url').value,token:document.getElementById('api_token').value}})}).then(r=>r.json()).then(d=>msg('âœ“ Saved')).catch(e=>msg('âœ— Error','error'))
}
async function loadCfg(){
 const d=await(await fetch('/api/cfg')).json();
 document.getElementById('api_url').value=d.api?.url||'';
 document.getElementById('api_token').value=d.api?.token||'';
 const cats=Object.keys(d.chans||{});
 document.getElementById('cat_sel').innerHTML=cats.map(c=>`<option>${c}</option>`).join('');
 document.getElementById('p_cat').innerHTML=cats.map(c=>`<option>${c}</option>`).join('');
 const allChans=[];
 cats.forEach(cat=>{
  if(d.chans[cat]&&Array.isArray(d.chans[cat])){
   d.chans[cat].forEach(ch=>allChans.push(ch))
  }
 });
 console.log('All channels:',allChans);
 document.getElementById('msg_ch_sel').innerHTML=allChans.length>0?allChans.map(c=>`<option>${c}</option>`).join(''):'<option>No channels found</option>';
 const roles=Object.keys(d.roles||{});
 document.getElementById('p_role').innerHTML=roles.map(r=>`<option>${r}</option>`).join('');
 refreshCh(d);refreshR(d);refreshP(d);refreshWh();
 setTimeout(refreshMsgs,500)
}
async function refreshMsgs(){
 const d=await(await fetch('/api/msgs')).json();
 const ch=document.getElementById('msg_ch_sel').value;
 if(!ch)return;
 document.getElementById('msg_txt').value=d.messages?.[ch]||'';
 document.getElementById('msg_prev').innerText=d.messages?.[ch]||'(no message set)'
}
function saveMsg(){
 const ch=document.getElementById('msg_ch_sel').value;
 const msg=document.getElementById('msg_txt').value;
 fetch('/api/msg/'+ch,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({msg:msg})}).then(r=>{msg('âœ“ Saved');refreshMsgs()}).catch(e=>msg('âœ— Error','error'))
}
setTimeout(()=>{
 const sel=document.getElementById('msg_ch_sel');
 if(sel)sel.addEventListener('change',refreshMsgs);
 const txt=document.getElementById('msg_txt');
 if(txt)txt.addEventListener('input',()=>{document.getElementById('msg_prev').innerText=txt.value||'(no message)'})
},500)
function addCh(){
 const cat=document.getElementById('cat_sel').value;
 const nm=document.getElementById('ch_name').value;
 fetch('/api/ch',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({act:'add',cat:cat,name:nm})}).then(r=>loadCfg()).catch(e=>msg('âœ— Error','error'))
}
function delCh(cat,nm){
 fetch('/api/ch',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({act:'del',cat:cat,name:nm})}).then(r=>loadCfg()).catch(e=>msg('âœ— Error','error'))
}
function refreshCh(d){
 let html='';
 for(let[cat,chans]of Object.entries(d.chans||{})){
  html+=`<div class="card"><strong>${cat}</strong><br>`;
  chans.forEach(ch=>html+=`<div style="display:flex;justify-content:space-between;padding:5px"><span>#${ch}</span><button class="btn danger"onclick="delCh('${cat}','${ch}')">Del</button></div>`);
  html+='</div>'
 }
 document.getElementById('ch_list').innerHTML=html
}
function addR(){
 fetch('/api/r',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({act:'add',name:document.getElementById('r_name').value,color:document.getElementById('r_col').value})}).then(r=>loadCfg()).catch(e=>msg('âœ— Error','error'))
}
function delR(nm){
 fetch('/api/r',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({act:'del',name:nm})}).then(r=>loadCfg()).catch(e=>msg('âœ— Error','error'))
}
function refreshR(d){
 let html=`<tr><th>Role</th><th>Color</th><th>Action</th></tr>`;
 for(let[nm,col]of Object.entries(d.roles||{})){
  html+=`<tr><td>${nm}</td><td><span style="display:inline-block;width:20px;height:20px;bg:${col};border-radius:3px"></span> ${col}</td><td><button class="btn danger"onclick="delR('${nm}')">Del</button></td></tr>`
 }
 document.getElementById('r_list').innerHTML=html
}
function addP(){
 fetch('/api/p',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({cat:document.getElementById('p_cat').value,role:document.getElementById('p_role').value,view:document.getElementById('p_view').checked,send:document.getElementById('p_send').checked})}).then(r=>loadCfg()).catch(e=>msg('âœ— Error','error'))
}
function refreshP(d){
 let html='';
 for(let[cat,perms]of Object.entries(d.perms||{})){
  html+=`<div class="card"><strong>${cat}</strong><table>`;
  for(let[role,p]of Object.entries(perms||{})){
   html+=`<tr><td>${role}</td><td>${p.view?'âœ“':'âœ—'}</td><td>${p.send?'âœ“':'âœ—'}</td></tr>`
  }
  html+='</table></div>'
 }
 document.getElementById('p_mat').innerHTML=html
}
async function refreshWh(){
 const d=await(await fetch('/api/wh')).json();
 let html=`<tr><th>ID</th><th>Trigger</th><th>URL</th><th>Action</th></tr>`;
 (d.webhooks||[]).forEach(w=>{html+=`<tr><td>${w.id}</td><td>${w.trigger}</td><td style="max-width:300px;overflow:auto">${w.url}</td><td><button class="btn danger"onclick="delWh(${w.id})">Del</button></td></tr>`});
 document.getElementById('wh_list').innerHTML=html
}
function addWh(){
 fetch('/api/wh',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({trigger:document.getElementById('wh_trig').value,url:document.getElementById('wh_url').value,active:true})}).then(r=>refreshWh()).catch(e=>msg('âœ— Error','error'))
}
function delWh(id){
 fetch(`/api/wh/${id}`,{method:'DELETE'}).then(r=>refreshWh()).catch(e=>msg('âœ— Error','error'))
}
async function exp(){
 const res=await fetch('/api/exp');
 const blob=await res.blob();
 const url=window.URL.createObjectURL(blob);
 const a=document.createElement('a');
 a.href=url;
 a.download='discord-server-builder-export.json';
 a.click()
}
function imp(e){
 const file=e.target.files[0];
 const r=new FileReader();
 r.onload=async(ev)=>{
  try{
   const d=JSON.parse(ev.target.result);
   await fetch('/api/imp',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(d)});
   msg('âœ“ Imported');
   loadCfg()
  }catch(err){msg('âœ— Invalid JSON','error')}
 };
 r.readAsText(file)
}
loadCfg()
</script>
</body>
</html>
